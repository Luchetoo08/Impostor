<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Imposthor ‚Äì Fiesta con Amigos</title>
  <style>
    :root{
      --bg:#0b1223; --panel:#0f172a; --panel-2:#0b1328; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --accent:#ff2e2e;
      --ok:#22c55e; --warn:#facc15; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:radial-gradient(1200px 800px at 80% -10%, #111a33 0%, var(--bg) 40%);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:24px;padding-left:clamp(12px,3vw,24px);padding-right:clamp(12px,3vw,24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:clamp(20px,3.5vw,32px);letter-spacing:.5px;color:var(--accent)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#b22222);box-shadow:var(--shadow);display:grid;place-items:center;font-weight:800}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .card .content{padding:20px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.auto{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-3{grid-template-columns:1fr}}
    .btn{border:none;border-radius:14px;padding:12px 16px;min-height:44px;cursor:pointer;font-weight:800;box-shadow:var(--shadow);background:linear-gradient(135deg,#ffffff,#d1d5db);color:#0b0f1a;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#ff6b6b);color:#fff}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn.success{background:linear-gradient(135deg,var(--ok),#86efac)}
    .btn.warning{background:linear-gradient(135deg,var(--warn),#fde047)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .center{text-align:center}
    .spacer{height:14px}
    .muted{color:var(--muted)}
    .title{font-size:clamp(18px,2.6vw,26px);margin:0 0 8px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;background:#0c162c;border:1px solid #1f2b46;color:var(--text);font-size:clamp(14px,3.6vw,16px)}
    .players{display:flex;flex-wrap:wrap;gap:10px}
    .pill{background:#0d1a33;border:1px solid #1f2b46;color:var(--text);border-radius:999px;padding:8px 12px;display:flex;align-items:center;gap:8px}
    .pill .x{cursor:pointer;opacity:.85}
    .chip{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(135deg,#0f213f,#0b1731);font-size:14px}
    .selectable{border:1px solid var(--line);background:#101b34;padding:12px;border-radius:12px;cursor:pointer;color:#ffffff;transition:border .15s ease,transform .08s ease,box-shadow .15s ease}
    .selectable:hover{transform:translateY(-1px)}
    .selectable.selected{border:2px solid var(--accent);box-shadow:0 0 0 3px rgba(255,46,46,.15) inset,0 6px 18px rgba(255,46,46,.18)}
    .notice{padding:12px 14px;border-radius:12px;background:#0c182e;border:1px dashed #23314f}
    .big{font-size:clamp(22px,6vw,38px);font-weight:900;letter-spacing:.5px;margin:6px 0;word-break:break-word}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #172033}
    .footer-nav{display:flex;justify-content:space-between;gap:10px;margin-top:16px;position:sticky;bottom:0;background:linear-gradient(180deg,transparent,rgba(11,18,35,.8));backdrop-filter:blur(6px);padding:8px 0}
    .hidden{display:none !important}
    .vote-instructions{color:#fbbf24;font-weight:800;letter-spacing:.3px}
    .vote-instructions::before{content:"‚ö†Ô∏è ";}

    /* Cartas Clash Royale */
    .cards-toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .cards-toolbar .btn{min-height:36px;padding:8px 12px;font-size:13px}
    #cardsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:14px}
    .cr-card{background:linear-gradient(180deg,#020617,#020818);border-radius:16px;border:1px solid var(--line);padding:12px;text-align:center;box-shadow:var(--shadow)}
    .cr-card-img{width:90px;height:90px;object-fit:contain;margin-bottom:6px}
    .cr-card-name{margin:4px 0 2px;font-size:14px;font-weight:800;color:#e5e7eb}
    .cr-card-rareza{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><div class="logo">üïµÔ∏è</div><h1>Imposthor ‚Äì Fiesta con Amigos</h1></div>
      <div class="row">
        <button class="btn ghost" id="btnBackMenu">Men√∫</button>
        <button class="btn ghost" id="btnReset">Reiniciar</button>
      </div>
    </header>

    <!-- Banner de categor√≠as activas -->
    <div id="roundBanner" class="hidden" style="margin:12px 0;">
      <div class="chip">
        Categor√≠as: <span id="roundCatsText"></span>
      </div>
    </div>

    <!-- MEN√ö PRINCIPAL -->
    <section id="screen-menu" class="grid cols-2">
      <div class="card"><div class="content">
        <h2 class="title">Crear partida r√°pida</h2>
        <p class="muted">Juego local en un solo dispositivo. Revelen rol, discutan y definan en grupo.</p>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn primary" id="createQuick">Crear partida</button>
          <span class="chip" id="roomCode">Sala ‚Äî ‚Äî ‚Äî</span>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn ghost" id="btnOpenCards">Cartas Clash Royale</button>
        </div>
        <div class="spacer"></div>
        <div class="notice">Tip: eleg√≠ <strong>categor√≠as</strong>. Todos reciben la misma palabra excepto el <strong>Impostor</strong>, que recibe <em>???</em>.</div>
      </div></div>
      <div class="card"><div class="content">
        <h2 class="title">C√≥mo se juega</h2>
        <ul class="list">
          <li><span>1) Agreg√° jugadores</span><span>üë•</span></li>
          <li><span>2) Eleg√≠ categor√≠as</span><span>üóÇÔ∏è</span></li>
          <li><span>3) Eleg√≠ la palabra</span><span>üîÄ</span></li>
          <li><span>4) Revel√° con <em>Mostrar</em></span><span>üì±</span></li>
          <li><span>5) Discusi√≥n y decisi√≥n grupal</span><span>üó≥Ô∏è</span></li>
          <li><span>6) Resultado y condici√≥n de victoria</span><span>üèÜ</span></li>
        </ul>
      </div></div>
    </section>

    <!-- LOBBY -->
    <section id="screen-lobby" class="hidden">
      <div class="grid cols-2">
        <div class="card"><div class="content">
          <h2 class="title">Jugadores</h2>
          <div class="row">
            <input id="playerName" type="text" maxlength="14" placeholder="Agregar jugador (Enter)" />
            <button class="btn" id="addPlayer">Agregar</button>
          </div>
          <div class="spacer"></div>
          <div class="players" id="players"></div>
          <div class="spacer"></div>
          <span class="muted">M√≠nimo 3 jugadores (m√°ximo 16).</span>
        </div></div>
        <div class="card"><div class="content">
          <h2 class="title">Categor√≠as</h2>
          <div id="categories" class="grid cols-3"></div>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn ghost" id="toggleAllCats">Seleccionar todas</button>
            <span class="muted">Eleg√≠ al menos 1</span>
          </div>
          <div class="spacer"></div>
          <h3 class="title" style="margin-top:8px">Impostores</h3>
          <div class="row" id="impostorPicker">
            <label class="chip"><input type="radio" name="impostors" value="1" checked style="margin-right:8px"> 1 impostor</label>
            <label class="chip"><input type="radio" name="impostors" value="2" style="margin-right:8px"> 2 impostores</label>
            <label class="chip"><input type="radio" name="impostors" value="3" style="margin-right:8px"> 3 impostores</label>
          </div>
        </div></div>
      </div>
      <div class="footer-nav">
        <button class="btn ghost" id="backMenu2">‚¨ÖÔ∏è Men√∫</button>
        <div class="row">
          <button class="btn warning" id="btnShuffle">üîÄ Elegir palabra</button>
          <button class="btn primary" id="startRound" disabled>‚ñ∂Ô∏è Iniciar ronda</button>
        </div>
      </div>
    </section>

    <!-- REVEAL -->
    <section id="screen-reveal" class="hidden">
      <div class="card"><div class="content center">
        <div class="muted">Jugador</div>
        <div class="big" id="revealPlayer">‚Äî</div>
        <div class="spacer"></div>
        <div class="notice" id="revealCard">Toquen <strong>Mostrar</strong> para ver su palabra/rol</div>
        <div class="spacer"></div>
        <div class="row center" style="justify-content:center;gap:12px;flex-wrap:wrap">
          <button class="btn" id="btnShow" style="flex:1 1 200px;max-width:360px">Mostrar</button>
          <button class="btn ghost" id="btnNext" style="flex:1 1 200px;max-width:360px">Siguiente ‚ñ∂Ô∏è</button>
        </div>
        <div class="spacer"></div>
        <div class="muted">Consejo: no digas tu palabra en voz alta üòâ</div>
      </div></div>
    </section>

    <!-- DISCUSI√ìN -->
    <section id="screen-discuss" class="hidden">
      <div class="card"><div class="content center">
        <h2 class="title">¬°A debatir!</h2>
        <p class="muted">Hablen 1‚Äì3 minutos. Cuando est√©n listos, pasen a votar.</p>
        <div class="spacer"></div>
        <button class="btn primary" id="goVote">üó≥Ô∏è Ir a votar</button>
      </div></div>
    </section>

    <!-- VOTACI√ìN (GRUPAL) -->
    <section id="screen-vote" class="hidden">
      <div class="card"><div class="content">
        <div class="row" style="justify-content:space-between">
          <div class="chip">üë• Vivos: <strong id="playersLeft">‚Äî</strong></div>
          <div class="chip">üé≠ Impostores: <strong id="impostorsLeft">‚Äî</strong></div>
        </div>
        <div class="spacer"></div>
        <div class="vote-instructions">Elijan en persona y luego toquen al acusado:</div>
        <div class="spacer"></div>
        <div id="voteList" class="grid auto"></div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn success" id="confirmVote">Confirmar decisi√≥n</button>
          <button class="btn ghost" id="skipVote">No eliminar</button>
        </div>
      </div></div>
    </section>

    <!-- RESULTADOS -->
    <section id="screen-results" class="hidden">
      <div class="card"><div class="content center">
        <h2 class="title">Resultados</h2>
        <div id="resultsBox"></div>
        <div class="spacer"></div>
        <div class="row center" style="justify-content:center">
          <button class="btn primary hidden" id="continueRound">Continuar</button>
          <button class="btn" id="playAgain">üîÅ Nueva ronda</button>
          <button class="btn ghost" id="toLobby">Lobby</button>
        </div>
      </div></div>
    </section>

    <!-- CARTAS CLASH ROYALE -->
    <section id="screen-cards" class="hidden">
      <div class="card">
        <div class="content">
          <h2 class="title">Cartas Clash Royale (MockAPI)</h2>
          <p class="muted">Se muestran cartas desde tus endpoints <code>comunes</code> y <code>cartas2</code>.</p>
          <div class="spacer"></div>
          <div class="cards-toolbar">
            <button class="btn ghost" data-filter="all" id="btnFilterAll">Todas</button>
            <button class="btn ghost" data-filter="Com√∫n" id="btnFilterComunes">Comunes</button>
            <button class="btn ghost" data-filter="Especial" id="btnFilterEspeciales">Especiales</button>
            <button class="btn ghost" data-filter="√âpica" id="btnFilterEpicas">√âpicas</button>
            <button class="btn ghost" data-filter="Legendaria" id="btnFilterLegendarias">Legendarias</button>
            <button class="btn ghost" data-filter="Campe√≥n" id="btnFilterCampeones">Campeones</button>
          </div>
          <div class="spacer"></div>
          <div id="cardsGrid"></div>
        </div>
      </div>
      <div class="footer-nav">
        <button class="btn ghost" id="backFromCards">‚¨ÖÔ∏è Men√∫</button>
      </div>
    </section>
  </div>

  <script>
    // ====== Palabras (categor√≠as) ======
    const wordPools = {
      "Clubes ARG": [], // ahora viene desde la API clubesarg
      "Clubes Mundo": [
        "Real Madrid","Barcelona","Atl√©tico de Madrid","Sevilla","Valencia","Manchester United","Manchester City","Liverpool","Arsenal","Chelsea",
        "Tottenham","Bayern Munich","Borussia Dortmund","PSG","AC Milan","Inter","Juventus","Napoli","Benfica","Porto",
        "Sporting CP","Ajax","Feyenoord","PSV","Roma","Lazio","Marseille","Lyon","Leverkusen","RB Leipzig"
      ],
      "Jugadores ARG": [
        "Messi","Di Mar√≠a","Dibu Mart√≠nez","De Paul","Enzo Fern√°ndez","Juli√°n √Ålvarez","Lautaro Mart√≠nez","Paredes","Otamendi","Cuti Romero","Garnacho","Mac Allister","Lo Celso","Tagliafico","Molina","Palacios","Montiel","Barco","Thiago Almada","Diablito Echeverri",
        "Nico Gonz√°lez","Buend√≠a","Mart√≠nez Quarta","Dybala","Correa","Foyth","Papu G√≥mez","Mascherano","Pastore","Aimar"
      ],
      "Jugadores Mundo (actuales)": [
        "Kylian Mbapp√©","Erling Haaland","Kevin De Bruyne","Cristiano Ronaldo","Neymar Jr","Jude Bellingham",
        "Vin√≠cius J√∫nior","Rodrygo","Mohamed Salah","Harry Kane","Robert Lewandowski","Karim Benzema",
        "Luka Modriƒá","Pedri","Gavi","Rodri","Bernardo Silva","Bruno Fernandes","Bukayo Saka",
        "Phil Foden","Jamal Musiala","Florian Wirtz","Joshua Kimmich","ƒ∞lkay G√ºndoƒüan","Frenkie de Jong",
        "Martin √òdegaard","Federico Valverde","Rafael Le√£o","Jo√£o F√©lix","Victor Osimhen","Khvicha Kvaratskhelia",
        "Heung-min Son","Antoine Griezmann","Ousmane Demb√©l√©","Achraf Hakimi","R√∫ben Dias","Virgil van Dijk",
        "Alphonso Davies","Thibaut Courtois","Alisson Becker","Ederson","Marc-Andr√© ter Stegen","Bruno Guimar√£es",
        "Nicol√≤ Barella","Declan Rice","Gabriel Martinelli","Darwin N√∫√±ez","Kai Havertz","Federico Chiesa","Leroy San√©"
      ],
      "Leyendas": [
        "Maradona","Pel√©","Zidane","Ronaldinho","Ronaldo Naz√°rio","Cruyff","Beckenbauer","Maldini","Xavi","Iniesta","Henry","Baggio","Figo","Rom√°rio","Shevchenko","Rooney","Ibrahimoviƒá","Roberto Carlos","Cafu","Totti",
        "Nedvƒõd","Gattuso","Pirlo","Kak√°","Eto'o","Cannavaro","Del Piero","Stoichkov","Van Basten","Platini"
      ],
      "Clash Royale": [
        "Caballero","Arqueras","Gigante","Mini P.E.K.K.A.","Beb√© Drag√≥n","Mago","Horda de Esbirros","Montapuercos","Valquiria","Mago de Hielo","Le√±ador","Bandida","Megacaballero","P.E.K.K.A.","Cementerio","Globo Bomb√°stico","Sabueso de Lava","Minero","Chispitas","Bruja Nocturna","Arquero M√°gico","Monje","Campe√≥n Dorado","Reina Arquera","Esqueleto Gigante","Pr√≠ncipe","Pr√≠ncipe Oscuro","Barril de Duendes","Duendes con Lanza","Ca√±√≥n con Ruedas","Tesla","Tornado","Descarga","Bola de Fuego","Cohete","Veneno","Rayo","Tronco","Flechas",
        "Fantasma Real","Carruaje de Ca√±√≥n","Pescador","Drag√≥n El√©ctrico","Dragones Esqueleto","F√©nix","Guardias","Mortero","Ballesta"
      ],
      "Pa√≠ses": [
        "Estados Unidos","China","India","Brasil","Rusia","Reino Unido","Francia","Alemania","Italia","Espa√±a",
        "Canad√°","M√©xico","Jap√≥n","Corea del Sur","Australia","Argentina","Chile","Colombia","Per√∫","Uruguay",
        "Portugal","Pa√≠ses Bajos","B√©lgica","Suiza","Suecia","Noruega","Dinamarca","Finlandia","Polonia","Austria",
        "Irlanda","Grecia","Rep√∫blica Checa","Hungr√≠a","Turqu√≠a","Israel","Arabia Saudita","Emiratos √Årabes Unidos","Qatar","Egipto",
        "Marruecos","Sud√°frica","Nigeria","Kenia","Argelia","Etiop√≠a","Ghana","Indonesia","Tailandia","Vietnam"
      ]
    };

    // ====== Estado ======
    const state = {
      room: null,
      players: [],
      selectedCategories: new Set(),
      usedWords: new Set(),
      currentWord: null, // string o {tipo:"club",nombre,imagen}
      impostorIdxs: [],
      impostorCount: 1,
      alive: [],
      revealStep: 0,
      revealed: false,
      selectedAccused: null,
    };

    // ====== Helpers ======
    const $ = sel => document.querySelector(sel);
    const randInt = n => Math.floor(Math.random()*n);
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];
    const genRoom = () => Array.from({length:4},()=>"ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[randInt(32)]).join('');
    const escapeHtml = str => String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[s]));
    function getImpostorNames(){ return state.impostorIdxs.map(i=>state.players[i]).filter(Boolean); }

    const save = () => localStorage.setItem('imposthor-lite', JSON.stringify({players:state.players, used:[...state.usedWords]}));
    const load = () => {
      try{
        const d = JSON.parse(localStorage.getItem('imposthor-lite')||'{}');
        if(Array.isArray(d.players)) state.players = d.players.slice(0,16);
        if(Array.isArray(d.used)) state.usedWords = new Set(d.used);
      }catch{}
    };

    // ====== Navegaci√≥n / Render ======
    function show(id){
      ["#screen-menu","#screen-lobby","#screen-reveal","#screen-discuss","#screen-vote","#screen-results","#screen-cards"].forEach(
        s=>$(s).classList.add('hidden')
      );
      $(id).classList.remove('hidden');
    }

    function renderPlayers(){
      const wrap = $('#players'); wrap.innerHTML='';
      state.players.forEach((name,i)=>{
        const el = document.createElement('div');
        el.className='pill';
        el.innerHTML = `<span>${escapeHtml(name)}</span> <span class="x" title="Quitar" data-i="${i}">‚úñ</span>`;
        wrap.appendChild(el);
      });
    }

    function renderCategories(){
      const box = $('#categories'); box.innerHTML='';
      Object.keys(wordPools).forEach(cat=>{
        const el = document.createElement('div');
        el.className='selectable';
        el.dataset.cat = cat;
        const extra = (cat === "Clubes ARG") ? 'API' : (wordPools[cat].length+" palabras");
        el.innerHTML = `<strong>${cat}</strong><div class="muted">${extra}</div>`;
        if(state.selectedCategories.has(cat)) el.classList.add('selected');
        box.appendChild(el);
      });
    }

    function updateStartButton(){
      const ok = state.players.length>=3 && state.selectedCategories.size>0 && !!state.currentWord;
      const btn = $('#startRound');
      if(btn) btn.disabled = !ok;
    }

    function updateRoundBanner(){
      const banner = $('#roundBanner');
      const textEl = $('#roundCatsText');
      if(!banner || !textEl) return;
      if(state.selectedCategories.size===0){
        banner.classList.add('hidden');
        textEl.textContent = '';
        return;
      }
      const cats = Array.from(state.selectedCategories);
      textEl.textContent = cats.join(' ¬∑ ');
      banner.classList.remove('hidden');
    }

    // ====== Clubes ARG (MockAPI) ======
    const API_CLUBES_ARG = "https://6918a60a21a963594870c317.mockapi.io/clubesarg";

    async function pickClubFromAPI(){
      try{
        const res = await fetch(API_CLUBES_ARG);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0){
          alert('No hay clubes en la API de Clubes ARG.');
          return false;
        }

        const disponibles = data.filter(c => !state.usedWords.has(c.nombre));
        const pool = disponibles.length ? disponibles : data;

        const elegido = choice(pool);
        const nombre = elegido.nombre || elegido.name || 'Club desconocido';

        state.currentWord = {
          tipo: 'club',
          nombre,
          imagen: elegido.imagen || elegido.image || ''
        };

        state.usedWords.add(nombre);
        save();
        return true;
      }catch(e){
        console.error(e);
        alert('Error al obtener clubes desde la API.');
        return false;
      }
    }

    // ====== Juego ======
    async function pickWord(){
      const soloClubesArg = state.selectedCategories.size === 1 && state.selectedCategories.has("Clubes ARG");

      if (soloClubesArg){
        const ok = await pickClubFromAPI();
        return ok;
      }

      let pool = [];
      for (const cat of state.selectedCategories){
        pool = pool.concat(wordPools[cat] || []);
      }
      const fresh = pool.filter(w => !state.usedWords.has(w));
      const usable = fresh.length>0 ? fresh : pool;
      if(usable.length===0){
        alert('No hay palabras en las categor√≠as seleccionadas.');
        return false;
      }
      state.currentWord = choice(usable);
      state.usedWords.add(state.currentWord);
      save();
      return true;
    }

    function startRound(){
      const desired = Math.max(1, Math.min(state.impostorCount, Math.max(1, state.players.length-1)));
      const chosen = new Set();
      while(chosen.size < desired){ chosen.add(randInt(state.players.length)); }
      state.impostorIdxs = Array.from(chosen);
      state.impostorCount = state.impostorIdxs.length;

      state.alive = Array(state.players.length).fill(true);
      state.revealStep = 0;
      state.revealed = false;
      updateRoundBanner();
      show('#screen-reveal');
      renderReveal();
    }

    function renderReveal(){
      const i = state.revealStep;
      const name = state.players[i] || '‚Äî';
      $('#revealPlayer').textContent = name;
      state.revealed = false;
      $('#btnShow').disabled = false;
      $('#revealCard').innerHTML = 'Toquen <strong>Mostrar</strong> para ver su palabra/rol';
    }

    function nextReveal(){
      if(!state.revealed){ alert('Primero toca "Mostrar" para ver tu rol.'); return; }
      if(state.revealStep < state.players.length-1){
        state.revealStep++;
        renderReveal();
      } else {
        show('#screen-discuss');
      }
    }

    function beginVoting(){
      state.selectedAccused = null;
      show('#screen-vote');
      renderVote();
    }

    function renderVote(){
      const playersLeft = state.alive.filter(Boolean).length;
      $('#playersLeft').textContent = playersLeft;
      $('#impostorsLeft').textContent = state.impostorCount;
      const list = $('#voteList'); list.innerHTML='';
      state.players.forEach((name,i)=>{
        if(!state.alive[i]) return;
        const b = document.createElement('button');
        b.className = 'btn selectable' + (state.selectedAccused===i ? ' selected' : '');
        b.style.textAlign='left';
        b.innerHTML = `üë§ ${escapeHtml(name)}`;
        b.onclick = ()=>{ state.selectedAccused = i; renderVote(); };
        list.appendChild(b);
      });
    }

    function confirmVote(){
      if(state.selectedAccused==null){ alert('Eleg√≠ a qui√©n acusan.'); return; }
      const accused = state.selectedAccused;
      state.alive[accused] = false;
      const wasImpostor = state.impostorIdxs.includes(accused);
      if(wasImpostor){
        state.impostorCount--;
        state.impostorIdxs = state.impostorIdxs.filter(x=>x!==accused);
      }
      showResultsAfterVote(accused, wasImpostor);
    }

    function showResultsAfterVote(accused, wasImpostor){
      const playersLeft = state.alive.filter(Boolean).length;
      const crewLeft = playersLeft - state.impostorCount;
      const accusedText = accused==null? 'Nadie' : state.players[accused];

      let outcome = null;
      if(state.impostorCount === 0){
        outcome = 'crew';
      } else if(state.impostorCount === crewLeft){
        outcome = 'impostors';
      }

      const verdict = accused==null
        ? '‚è∏Ô∏è Decidieron no eliminar a nadie'
        : (wasImpostor ? '‚úÖ Era el IMPOSTOR' : '‚ùå No era el impostor');

      let wordBlock = '';
      if(outcome !== null){
        let palabraMostrada = '';
        if(state.currentWord){
          if(typeof state.currentWord === 'object' && state.currentWord.tipo === 'club'){
            palabraMostrada = state.currentWord.nombre || '';
          } else {
            palabraMostrada = String(state.currentWord);
          }
        }
        if(palabraMostrada){
          wordBlock = `
            <p class="muted">Palabra de la ronda:</p>
            <div class="big">${escapeHtml(palabraMostrada)}</div>
            <div class="spacer"></div>
          `;
        }
      } else {
        wordBlock = `
          <p class="muted">La palabra permanecer√° oculta hasta que termine la partida.</p>
          <div class="spacer"></div>
        `;
      }

      let statusLine = `üë• Vivos: <strong>${playersLeft}</strong> | üé≠ Impostores restantes: <strong>${state.impostorCount}</strong>`;
      if(outcome==='crew') statusLine += ' ‚Äî üèÜ Ganan los tripulantes';
      if(outcome==='impostors') statusLine += ' ‚Äî üè¥ Ganan los impostores';

      const impostorsLine = outcome==='impostors'
        ? `<p class="muted">Impostor(es): <strong>${getImpostorNames().map(escapeHtml).join(', ')}</strong></p>`
        : '';

      $('#resultsBox').innerHTML = `
        ${wordBlock}
        <p>Acusado: <strong>${escapeHtml(accusedText)}</strong></p>
        <p>${verdict}</p>
        ${impostorsLine}
        <div class="spacer"></div>
        <div class="chip">${statusLine}</div>
      `;

      const btnCont = $('#continueRound');
      const btnAgain = $('#playAgain');
      if(outcome===null){
        btnCont.classList.remove('hidden');
        btnAgain.classList.add('hidden');
      } else {
        btnCont.classList.add('hidden');
        btnAgain.classList.remove('hidden');
      }

      show('#screen-results');
    }

    // ====== Cartas Clash Royale (MockAPI) ======
    const API_COMUNES = "https://6917a7c721a96359486d94bb.mockapi.io/comunes";
    const API_ALTAS  = "https://6917a7c721a96359486d94bb.mockapi.io/cartas2";

    let allCards = [];

    function getRarezaColor(r){
      if (r === "Com√∫n") return "#b9b9b9";
      if (r === "Especial") return "#4bc9ff";
      if (r === "√âpica") return "#c66bff";
      if (r === "Legendaria") return "#ffb300";
      if (r === "Campe√≥n") return "#1e88e5";
      return "#ffffff";
    }

    function renderCards(list){
      const grid = document.getElementById("cardsGrid");
      grid.innerHTML = "";
      if(!list || list.length === 0){
        grid.innerHTML = `<p class="muted">No se encontraron cartas para este filtro.</p>`;
        return;
      }
      list.forEach(carta=>{
        const card = document.createElement("div");
        const color = getRarezaColor(carta.rareza);
        card.className = "cr-card";
        card.innerHTML = `
          <img class="cr-card-img" src="${carta.imagen}" alt="${escapeHtml(carta.name)}">
          <div class="cr-card-name" style="color:${color}">${escapeHtml(carta.name)}</div>
          <div class="cr-card-rareza">${escapeHtml(carta.rareza || "")}</div>
        `;
        grid.appendChild(card);
      });
    }

    async function loadCards(){
      if(allCards.length) {
        renderCards(allCards);
        return;
      }
      const grid = document.getElementById("cardsGrid");
      grid.innerHTML = `<p class="muted">Cargando cartas...</p>`;
      try{
        const [r1,r2] = await Promise.all([fetch(API_COMUNES), fetch(API_ALTAS)]);
        const d1 = await r1.json();
        const d2 = await r2.json();
        allCards = [...d1, ...d2];
        renderCards(allCards);
      }catch(e){
        console.error(e);
        grid.innerHTML = `<p class="muted">Error al cargar las cartas.</p>`;
      }
    }

    function filterCardsByRareza(rareza){
      if(!allCards.length) return;
      if(rareza === "all"){
        renderCards(allCards);
      } else {
        renderCards(allCards.filter(c=>c.rareza === rareza));
      }
    }

    // ====== Eventos UI ======
    $('#createQuick').addEventListener('click', () => {
      state.room = genRoom();
      $('#roomCode').textContent = `Sala ${state.room}`;
      show('#screen-lobby');
      renderPlayers();
      renderCategories();
      document.querySelectorAll('input[name="impostors"]').forEach(r=>{
        r.addEventListener('change',()=>{
          const val = parseInt(r.value,10);
          state.impostorCount = isNaN(val)?1:val;
        });
      });
      updateStartButton();
    });

    $('#backMenu2').addEventListener('click', () => show('#screen-menu'));
    $('#btnBackMenu').addEventListener('click', () => show('#screen-menu'));
    $('#btnReset').addEventListener('click', () => {
      if(confirm('¬øSeguro que quer√©s reiniciar la aplicaci√≥n?')){
        localStorage.removeItem('imposthor-lite');
        location.reload();
      }
    });

    $('#playerName').addEventListener('keydown', e=>{ if(e.key==='Enter') addPlayer(); });
    $('#addPlayer').addEventListener('click', addPlayer);

    function addPlayer(){
      const name = $('#playerName').value.trim();
      if(!name) return;
      if(state.players.includes(name)) { alert('Ese nombre ya est√° en la lista.'); return; }
      if(state.players.length>=16) { alert('M√°ximo 16 jugadores.'); return; }
      state.players.push(name);
      $('#playerName').value='';
      renderPlayers();
      updateStartButton();
      save();
    }

    $('#players').addEventListener('click', e=>{
      if(e.target.classList.contains('x')){
        const i = +e.target.getAttribute('data-i');
        state.players.splice(i,1);
        renderPlayers();
        updateStartButton();
        save();
      }
    });

    $('#categories').addEventListener('click', e=>{
      const item = e.target.closest('.selectable');
      if(!item) return;
      const cat = item.getAttribute('data-cat');
      if(state.selectedCategories.has(cat)) state.selectedCategories.delete(cat); else state.selectedCategories.add(cat);
      item.classList.toggle('selected');
      updateStartButton();
    });

    $('#toggleAllCats').addEventListener('click', () => {
      const all = Object.keys(wordPools);
      const allSelected = all.every(c=>state.selectedCategories.has(c));
      state.selectedCategories = new Set(allSelected?[]:all);
      renderCategories();
      updateStartButton();
    });

    $('#btnShuffle').addEventListener('click', async () => {
      if(state.selectedCategories.size===0) { alert('Eleg√≠ al menos una categor√≠a.'); return; }
      const ok = await pickWord();
      if(ok){
        updateStartButton();
        alert('Palabra elegida para la ronda.');
      }
    });

    $('#startRound').addEventListener('click', async () => {
      if(!(state.players.length>=3)) { alert('M√≠nimo 3 jugadores.'); return; }
      if(state.selectedCategories.size===0) { alert('Seleccion√° categor√≠as.'); return; }
      if(!state.currentWord){
        const ok = await pickWord();
        if(!ok) return;
      }
      startRound();
    });

    $('#btnShow').addEventListener('click', () => {
      if(state.revealed) return;
      const i = state.revealStep;
      const isImp = state.impostorIdxs.includes(i);

      let text;

      if (isImp){
        text = 'Eres el <strong>IMPOSTOR</strong><br/><span class="muted">Tu palabra es: <em>???</em></span>';
      } else {
        if (state.currentWord && typeof state.currentWord === 'object' && state.currentWord.tipo === 'club'){
          const nombre = state.currentWord.nombre || 'Club desconocido';
          const img = state.currentWord.imagen
            ? `<img src="${state.currentWord.imagen}" alt="${escapeHtml(nombre)}" style="width:120px;height:120px;object-fit:contain;display:block;margin:0 auto 8px;">`
            : '';
          text = `
            ${img}
            <div>Tu club es: <strong>${escapeHtml(nombre)}</strong></div>
          `;
        } else {
          text = `Tu palabra es: <strong>${escapeHtml(state.currentWord)}</strong>`;
        }
      }

      $('#revealCard').innerHTML = `<div class="notice">${text}</div>`;
      state.revealed = true;
      $('#btnShow').disabled = true;
    });

    $('#btnNext').addEventListener('click', nextReveal);
    $('#goVote').addEventListener('click', beginVoting);
    $('#confirmVote').addEventListener('click', confirmVote);
    $('#skipVote').addEventListener('click', () => { showResultsAfterVote(null,false); });
    $('#continueRound').addEventListener('click', () => { beginVoting(); });
    $('#playAgain').addEventListener('click', async () => {
      const ok = await pickWord();
      if(ok) startRound();
    });
    $('#toLobby').addEventListener('click', () => { show('#screen-lobby'); updateStartButton(); });

    // Navegaci√≥n a cartas
    document.getElementById('btnOpenCards').addEventListener('click', () => {
      show('#screen-cards');
      loadCards();
    });

    document.getElementById('backFromCards').addEventListener('click', () => {
      show('#screen-menu');
    });

    // Filtros de rareza
    document.getElementById('btnFilterAll').addEventListener('click', () => filterCardsByRareza('all'));
    document.getElementById('btnFilterComunes').addEventListener('click', () => filterCardsByRareza('Com√∫n'));
    document.getElementById('btnFilterEspeciales').addEventListener('click', () => filterCardsByRareza('Especial'));
    document.getElementById('btnFilterEpicas').addEventListener('click', () => filterCardsByRareza('√âpica'));
    document.getElementById('btnFilterLegendarias').addEventListener('click', () => filterCardsByRareza('Legendaria'));
    document.getElementById('btnFilterCampeones').addEventListener('click', () => filterCardsByRareza('Campe√≥n'));

    // init
    load();
    renderCategories();
  </script>
</body>
</html>
